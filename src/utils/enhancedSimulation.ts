/**
 * Enhanced AI simulation with intelligent triggers for demo purposes
 * This system detects user intent and triggers contextual interactions
 * including products, nutritionists, forum posts, and location-based recommendations
 */

import { nutritionists, nutritionistReviews } from '@/data/nutritionists';
import { sampleProducts } from '@/data/products';
import { forumPosts } from '@/data/forum';

export interface SimulationTrigger {
  type: 'product' | 'nutritionist' | 'forum' | 'location' | 'recipe' | 'generic';
  data?: unknown;
}

export interface EnhancedResponse {
  text: string;
  trigger?: SimulationTrigger;
  shouldRequestLocation?: boolean;
}

/**
 * Simulates AI-powered review summary with keyword extraction
 */
function summarizeReviews(nutritionistId: string): string {
  const reviews = nutritionistReviews.filter(r => r.nutritionistId === nutritionistId);
  
  if (reviews.length === 0) return '';
  
  const avgRating = reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length;
  const positiveCount = reviews.filter(r => r.rating >= 4).length;
  
  // Extract keywords from reviews
  const stopwords = [
    'el', 'la', 'los', 'las', 'un', 'una', 'unos', 'unas', 'de', 'del', 'y', 'a', 'en', 'que', 'con', 'por', 'para', 
    'es', 'muy', 'lo', 'su', 'al', 'le', 'se', 'me', 'mi', 'tu', 'sus', 'ha', 'pero', 'como', 'm√°s', 'ya', 'no', 
    's√≠', 'fue', 'gran', 'todo', 'tambi√©n', 'porque', 'sobre', 'sin', 'hace', 'bien', 'son', 'si', 'nos', 'da'
  ];
  
  const positiveKeywords = [
    'profesional', 'profesionalismo', 'amable', 'resultados', 'efectivos', 'personalizado', 'seguimiento', 
    'atenci√≥n', 'dedicaci√≥n', 'experiencia', 'conocimiento', 'ayuda', 'recomiendo', 'excelente', 'confianza', 
    'mejor', 'apoyo', 'trato', 'paciente', 'explica', 'detallado', 'motiva', 'responsable', 'cambi√≥', 'energ√≠a'
  ];
  
  const wordCounts: Record<string, number> = {};
  
  for (const review of reviews) {
    const words = review.comment
      .toLowerCase()
      .replace(/[.,;:¬°!¬ø?\(\)\[\]"]/g, '')
      .split(/\s+/)
      .filter(w => w && !stopwords.includes(w));
    
    for (const word of words) {
      if (positiveKeywords.includes(word)) {
        wordCounts[word] = (wordCounts[word] || 0) + 1;
      }
    }
  }
  
  // Get top 3 keywords
  const sortedKeywords = Object.entries(wordCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3)
    .map(([word]) => word);
  
  let highlights = '';
  if (sortedKeywords.length > 0) {
    highlights = `\n‚Ä¢ Los pacientes destacan: ${sortedKeywords.join(', ')}`;
  }
  
  return `\n\nüìä **Resumen de ${reviews.length} rese√±as** (IA):\n‚Ä¢ Calificaci√≥n promedio: ${avgRating.toFixed(1)}/5.0\n‚Ä¢ ${positiveCount} rese√±as muy positivas${highlights}`;
}

/**
 * Helper to extract user context from conversation history
 */
function extractUserContext(conversationHistory: Array<{ role: string; content: string }>): {
  hasSharedGoals: boolean;
  hasSharedRestrictions: boolean;
  hasAskedAboutRecipes: boolean;
  hasAskedAboutProducts: boolean;
  hasAskedAboutNutritionists: boolean;
  mentionedVegetarian: boolean;
  mentionedAllergies: boolean;
  mentionedWeightLoss: boolean;
  mentionedDiabetes: boolean;
  mentionedSports: boolean;
} {
  const allUserMessages = conversationHistory.filter(m => m.role === 'user').map(m => m.content.toLowerCase()).join(' ');
  
  // Only count sports if actively doing exercise, not if they say they DON'T exercise
  const mentionsSports = /(crossfit|hago.*deporte|soy.*atleta|voy.*gym|entreno|hago.*fitness|hago.*ejercicio)/i.test(allUserMessages) && 
                         !/(no.*ejercicio|poco ejercicio|sin ejercicio)/i.test(allUserMessages);
  
  return {
    hasSharedGoals: /(kg|kilo|peso.*mes|mes.*peso|plazo|semana|d√≠as)/i.test(allUserMessages),
    hasSharedRestrictions: /(vegetariano|vegetariana|vegano|vegana|alergia|intolerancia|no como|no me gusta)/i.test(allUserMessages),
    hasAskedAboutRecipes: /(receta|cocinar|preparar)/i.test(allUserMessages),
    hasAskedAboutProducts: /(producto|comprar|tienda)/i.test(allUserMessages),
    hasAskedAboutNutritionists: /(nutricionista|doctor|profesional|consulta)/i.test(allUserMessages),
    mentionedVegetarian: /(vegetariano|vegetariana|vegano|vegana)/i.test(allUserMessages),
    mentionedAllergies: /(alergia|al√©rgico|intolerancia)/i.test(allUserMessages),
    mentionedWeightLoss: /(bajar|peso|adelgazar|perder)/i.test(allUserMessages),
    mentionedDiabetes: /(diabetes|diab√©tico|glucosa|az√∫car en sangre)/i.test(allUserMessages),
    mentionedSports: mentionsSports,
  };
}

/**
 * Enhanced message categorization with smart triggers and context awareness
 */
export function categorizeWithTriggers(
  message: string,
  conversationHistory: Array<{ role: string; content: string }> = [],
  userLocation?: { latitude: number; longitude: number }
): EnhancedResponse {
  const lower = message.toLowerCase();
  const context = extractUserContext(conversationHistory);
  
  // Detect greetings - More personalized based on context
  if (/(hola|buenos d√≠as|buenas tardes|buenas noches|hey|hi|saludos)/i.test(lower) && conversationHistory.length === 0) {
    // Check if user mentions they have experience in the greeting
    if (/(llevo.*mes|llevo.*a√±o|tengo experiencia)/i.test(lower)) {
      return {
        text: '¬°Hola! üëã Excelente que ya tengas experiencia en keto. Soy **Keto Friend**, tu amigo personal en el estilo de vida cetog√©nico.\n\nüí™ Como ya conoces los fundamentos, puedo ayudarte a optimizar tu keto:\n\nüéØ Variedad en recetas para no aburrirte\nüèãÔ∏è Nutrici√≥n deportiva y rendimiento\nüìä Ajuste fino de macros\nüë®‚Äç‚öïÔ∏è Acceso a nutricionistas especializados\nüí¨ Consejos avanzados de la comunidad\nüõí Productos especializados\n\n¬øEn qu√© √°rea te gustar√≠a mejorar hoy? üòä',
      };
    }
    
    return {
      text: '¬°Hola! üëã Soy **Keto Friend**, tu amigo personal en el estilo de vida cetog√©nico. Estoy aqu√≠ para hacer tu viaje keto m√°s f√°cil y delicioso.\n\nüíö **Puedo ayudarte con:**\n\nüç≥ Recetas personalizadas seg√∫n tus gustos\nüõí Recomendaciones de productos keto\nüë®‚Äç‚öïÔ∏è Conectarte con nutricionistas expertos\nüí¨ Compartir lo que dice la comunidad\nüìç Encontrar especialistas cerca de ti\nüéØ Crear planes de comidas personalizados\nüí™ Consejos para combinar keto con ejercicio\n\n¬øCu√©ntame, eres nuevo en keto o ya llevas tiempo en este estilo de vida? üòä',
    };
  }
  
  // Follow-up to greeting - Natural conversation starter (beginner)
  if (/(nuevo|nueva|empezando|principiante|acabo de empezar|primera vez|nunca|no s√©)/i.test(lower) && 
      conversationHistory.length >= 1 && conversationHistory.length <= 4 &&
      !/(llevo|meses|a√±os)/i.test(lower)) {
    return {
      text: '¬°Genial que est√©s comenzando! üåü La dieta keto puede parecer intimidante al principio, pero no te preocupes, estoy aqu√≠ para guiarte paso a paso.\n\n**Los 3 pilares del √©xito en keto:**\n\n1Ô∏è‚É£ **Entender tus macros**: Mantener carbohidratos bajo 20-30g netos al d√≠a\n2Ô∏è‚É£ **Planificaci√≥n**: Tener recetas y productos keto a mano\n3Ô∏è‚É£ **Apoyo profesional**: Un nutricionista te ayuda a personalizar todo\n\nüí° **Mi consejo:** Empecemos con lo b√°sico. ¬øQu√© comida del d√≠a te preocupa m√°s? ¬øDesayuno, almuerzo o cena? O si prefieres, puedo mostrarte productos keto para empezar tu despensa. ü•ë',
    };
  }
  
  // If user says they're experienced (but not if asking about weight loss timeframe)
  if (/(llevo.*mes|llevo.*a√±o|tengo experiencia|ya s√©|ya conozco)/i.test(lower) && 
      conversationHistory.length >= 1 && conversationHistory.length <= 4 &&
      !/(bajar|peso|perder|adelgazar)/i.test(lower)) {
    return {
      text: '¬°Excelente! Me encanta trabajar con alguien que ya conoce los fundamentos. üí™\n\nYa que tienes experiencia, puedo ayudarte a llevar tu keto al siguiente nivel:\n\nüéØ **Optimizaci√≥n avanzada:**\n‚Ä¢ Variedad en recetas para no aburrirte\n‚Ä¢ Productos especializados (snacks, postres keto gourmet)\n‚Ä¢ Ajuste de macros para objetivos espec√≠ficos\n‚Ä¢ Consultas con nutricionistas para afinar detalles\n\n¬øHay algo espec√≠fico que quieras mejorar en tu estilo de vida keto actual? Por ejemplo:\n- M√°s variedad en comidas\n- Optimizar para deporte/rendimiento\n- Recetas m√°s r√°pidas para tu rutina\n- Control m√°s preciso de resultados',
    };
  }

  // Thank you / positive feedback - Higher priority, placed earlier
  if (/(gracias|thank|excelente|genial|perfecto|me ayud√≥|me ayudaste|√∫til)/i.test(lower) && conversationHistory.length > 4) {
    return {
      text: '¬°Me alegra mucho poder ayudarte! üíö Ese es mi prop√≥sito como tu Keto Friend.\n\nRecuerda que estoy aqu√≠ siempre que me necesites. Puedo ayudarte con:\n\n‚Ä¢ M√°s recetas cuando necesites variedad\n‚Ä¢ Resolver dudas sobre s√≠ntomas o ajustes\n‚Ä¢ Recomendarte productos para facilitarte la vida\n‚Ä¢ Conectarte con nutricionistas cuando quieras apoyo profesional\n‚Ä¢ ¬°Y mucho m√°s!\n\nüí° **Consejo final:** La clave del √©xito en keto es la consistencia, no la perfecci√≥n. Un d√≠a "fuera de plan" no arruina tu progreso. ¬°Sigue adelante!\n\n¬øHay algo m√°s en lo que pueda ayudarte hoy? üòä',
    };
  }
  
  // Shopping cart / purchase intent
  if (/(carrito|comprar|agregar|a√±adir|quiero.*producto|me interesa.*producto)/i.test(lower) && context.hasAskedAboutProducts) {
    return {
      text: '¬°Genial! Para agregar productos al carrito y completar tu compra:\n\n1Ô∏è‚É£ Haz clic en el bot√≥n "Agregar al carrito" de cualquier producto que te mostr√©\n2Ô∏è‚É£ Revisa tu carrito en el √≠cono üõí arriba\n3Ô∏è‚É£ Puedes contactarnos por WhatsApp para procesar tu pedido\n\nüí° **Tip:** Si es tu primera compra, te recomiendo el "Kit de Inicio Keto" que incluye:\n‚Ä¢ Snacks variados\n‚Ä¢ Edulcorantes\n‚Ä¢ Productos b√°sicos\n‚Ä¢ ¬°Y un descuento del 15%!\n\n¬øNecesitas ayuda para decidir qu√© comprar o tienes preguntas sobre env√≠os? üì¶',
    };
  }
  
  // Scheduling / appointment
  if (/(agendar|cita|consulta|reservar|horario|disponibilidad|c√≥mo agendo)/i.test(lower) && context.hasAskedAboutNutritionists) {
    return {
      text: '¬°Perfecto! Agendar una cita es s√∫per f√°cil. üìÖ\n\n**PASOS PARA AGENDAR:**\n\n1Ô∏è‚É£ Selecciona tu nutricionista preferido\n   (Si no est√°s seguro, puedo recomendarte uno seg√∫n tus objetivos)\n\n2Ô∏è‚É£ Revisa horarios disponibles en su tarjeta\n   (Generalmente de 8am a 6pm, Lun-Sab)\n\n3Ô∏è‚É£ Click en "Agendar Cita"\n   Te contactaremos por WhatsApp para confirmar\n\n**PRECIOS:**\n‚Ä¢ Primera consulta: $40-60 USD (incluye plan personalizado)\n‚Ä¢ Seguimientos: $35-45 USD\n‚Ä¢ Paquetes: Descuentos en 3+ sesiones\n\n**QU√â INCLUYE LA CONSULTA:**\n‚úÖ Evaluaci√≥n completa de tu caso\n‚úÖ Plan nutricional personalizado\n‚úÖ C√°lculo exacto de macros\n‚úÖ Lista de compras\n‚úÖ Recetas adaptadas\n‚úÖ Seguimiento por WhatsApp (1 semana)\n\nüí° **Mi recomendaci√≥n:** La primera consulta es una inversi√≥n que vale la pena. El nutricionista ajusta todo espec√≠ficamente para TI, no solo consejos generales.\n\n¬øQuieres que te muestre los nutricionistas disponibles seg√∫n tu objetivo? üéØ',
    };
  }
  
  // Location-based nutritionist recommendation
  if (/(cerca|cercano|ubicaci√≥n|location|cerca de m√≠|nearby)/i.test(lower) && /(nutricionista|doctor|especialista)/i.test(lower)) {
    if (!userLocation) {
      return {
        text: '¬°Excelente! Para recomendarte nutricionistas cercanos, necesito acceso a tu ubicaci√≥n. üìç\n\n¬øMe permites acceder a tu ubicaci√≥n para mostrarte los especialistas m√°s cercanos?',
        shouldRequestLocation: true,
      };
    } else {
      // Simulate location-based recommendation
      const nearbyNutritionist = nutritionists[Math.floor(Math.random() * nutritionists.length)];
      const distance = (Math.random() * 5 + 0.5).toFixed(1); // 0.5-5.5 km
      
      return {
        text: `üìç Encontr√© especialistas cerca de ti:\n\n**${nearbyNutritionist.name}** - ${distance} km de distancia\n${nearbyNutritionist.specialty}\n‚≠ê ${nearbyNutritionist.rating}/5.0 (${nearbyNutritionist.reviewCount} rese√±as)\nüíµ $${nearbyNutritionist.price} USD/sesi√≥n\n\nüïê Disponibilidad:\n${nearbyNutritionist.availability.map(a => `‚Ä¢ ${a.day}: ${a.hours}`).join('\n')}\n\n¬øTe gustar√≠a agendar una cita con ${nearbyNutritionist.name.split(' ')[1]}?`,
        trigger: {
          type: 'nutritionist',
          data: nearbyNutritionist,
        },
      };
    }
  }

  // Nutritionist recommendation with AI review summary - Moved before products to prioritize context
  if (/(nutricionista|doctor|especialista|profesional|consulta|ayuda profesional)/i.test(lower)) {
    let recommendedNutritionist;
    
    // Check sports FIRST (most specific context)
    if (/(deporte|ejercicio|atleta|gym|rendimiento|crossfit|fitness|entrenar)/i.test(lower) || context.mentionedSports) {
      recommendedNutritionist = nutritionists.find(n => n.id === 'n2');
    } else if (/(diabetes|glucosa|az√∫car)/i.test(lower) || context.mentionedDiabetes) {
      recommendedNutritionist = nutritionists.find(n => n.id === 'n4');
    } else if (/(peso|adelgazar|bajar|perder|obesidad)/i.test(lower) || context.mentionedWeightLoss) {
      recommendedNutritionist = nutritionists.find(n => n.id === 'n3');
    } else {
      recommendedNutritionist = nutritionists.find(n => n.id === 'n1');
    }

    if (recommendedNutritionist) {
      const reviewSummary = summarizeReviews(recommendedNutritionist.id);
      
      return {
        text: `Te recomiendo a **${recommendedNutritionist.name}**\n\n${recommendedNutritionist.specialty}\n\n${recommendedNutritionist.description}\n\nüìú Certificaciones:\n${recommendedNutritionist.certifications.map(c => `‚Ä¢ ${c}`).join('\n')}\n\nüíµ Consulta: $${recommendedNutritionist.price} USD\nüó£Ô∏è Idiomas: ${recommendedNutritionist.languages.join(', ')}${reviewSummary}\n\n¬øQuieres que te ayude a agendar una cita?`,
        trigger: {
          type: 'nutritionist',
          data: recommendedNutritionist,
        },
      };
    }
  }


  // Product recommendations - Enhanced with shopping assistance
  if (/(producto|comprar|tienda|recomienda.*producto|necesito comprar|qu√©.*necesito|snack|chocolate)/i.test(lower)) {
    const isSnackRequest = /(snack|botana|merienda|tentempi√©)/i.test(lower);
    const isChocolateRequest = /(chocolate|cacao|dulce|postre)/i.test(lower);
    const isStarterKit = /(empezar|principiante|despensa|inicio|todo|completo|necesito.*para|qu√©.*necesito)/i.test(lower);
    const isBudget = /(barato|econ√≥mico|precio|ahorro)/i.test(lower);
    const isVegetarian = context.mentionedVegetarian;
    
    // Starter kit for beginners
    if (isStarterKit || (conversationHistory.length <= 10 && /(qu√©.*necesito|necesito comprar)/i.test(lower))) {
      return {
        text: '¬°Excelente pregunta! Para empezar en keto, estos son los productos esenciales que debes tener en tu despensa: üõí\n\n**Kit Inicial Keto (B√°sico)**\n\n**Grasas Saludables:**\nü•ë Aceite de coco ($12.99)\nü•ë Aceite de oliva extra virgen ($15.99)\nüßà Mantequilla grass-fed ($8.99)\nü•ú Mantequilla de almendra ($11.99)\n\n**Prote√≠nas:**\nü•ì Tocino sin az√∫car ($7.99)\nüßÄ Quesos variados ($18.99 pack)\nü•ö Huevos org√°nicos ($5.99)\n\n**Snacks:**\nüç´ Chocolate negro 85% ($4.99)\nüå∞ Mix de nueces ($9.99)\nüßÄ Chicharrones ($3.99)\n\n**Endulzantes y Condimentos:**\nüçØ Stevia l√≠quida ($8.99)\nüßÇ Sal del Himalaya ($6.99)\nüåø Especias variadas ($12.99)\n\nüí∞ **Total aproximado:** $130-150 USD\n‚è∞ **Duraci√≥n:** 2-3 semanas\n\nüí° **Tip de ahorro:** Empieza con los b√°sicos (aceites, huevos, queso, verduras) y ve agregando poco a poco.\n\n¬øQuieres que te muestre productos espec√≠ficos de nuestra tienda? Tengo ofertas especiales en packs de inicio. üòä',
        trigger: {
          type: 'product',
          data: sampleProducts.slice(0, 6),
        },
      };
    }
    
    // Budget-friendly options
    if (isBudget) {
      return {
        text: '¬°Entiendo perfectamente! La dieta keto no tiene que ser cara. Aqu√≠ est√°n mis recomendaciones econ√≥micas: üí∞\n\n**Productos Keto Econ√≥micos:**\n\n**Prote√≠nas Accesibles:**\nü•ö Huevos ($5.99/docena)\n   ‚Ä¢ M√°s vers√°til y econ√≥mico\n   ‚Ä¢ 0.5g carbos por huevo\n\nüêî Pollo entero ($8.99/kg)\n   ‚Ä¢ M√°s barato que pechuga sola\n   ‚Ä¢ Puedes usar todo\n\nü•´ At√∫n en lata ($1.99/lata)\n   ‚Ä¢ Conveniente y duradero\n   ‚Ä¢ Alto en prote√≠na\n\n**Grasas Saludables:**\nü•ë Aguacates ($1.50 c/u)\n   ‚Ä¢ En temporada son baratos\n   ‚Ä¢ Multiusos\n\nüßà Mantequilla regular ($4.99)\n   ‚Ä¢ No necesita ser grass-fed para empezar\n   ‚Ä¢ Dura mucho\n\n**Snacks Econ√≥micos:**\nüßÄ Queso en barra ($6.99)\n   ‚Ä¢ Corta porciones t√∫ mismo\n   ‚Ä¢ M√°s barato que pre-cortado\n\nüå∞ Cacahuates naturales ($3.99)\n   ‚Ä¢ Grasa saludable\n   ‚Ä¢ Saciante\n\nüí° **Tips para ahorrar:**\n1. Compra al mayoreo (aceites, nueces)\n2. Busca ofertas de prote√≠nas\n3. Meal prep = menos desperdicio\n4. Productos de marca propia vs. marca\n\n**Kit econ√≥mico semanal:** $35-45 USD\n\n¬øTe muestro recetas econ√≥micas que puedes hacer con estos productos? üç≥',
        trigger: {
          type: 'product',
          data: sampleProducts.filter((_, i) => i % 2 === 0).slice(0, 4),
        },
      };
    }
    
    // Vegetarian products
    if (isVegetarian) {
      return {
        text: '¬°Perfecto! Tengo excelentes productos keto vegetarianos para ti: üå±\n\n**Prote√≠nas Vegetales:**\nüå∞ Mantequilla de almendra org√°nica ($11.99)\n   ‚Ä¢ 8g prote√≠na por porci√≥n\n   ‚Ä¢ Grasas saludables\n   ‚Ä¢ Sin az√∫car a√±adida\n\nü•ú Mix de nueces premium ($9.99)\n   ‚Ä¢ Almendras, nueces, macadamias\n   ‚Ä¢ Alto en omega-3\n   ‚Ä¢ Perfecto para snacking\n\n**Grasas Saludables:**\nü•• Aceite de coco virgen ($12.99)\n   ‚Ä¢ MCT naturales\n   ‚Ä¢ Ideal para cocinar\n   ‚Ä¢ Aumenta cetonas\n\nü´í Aceite de oliva extra virgen ($15.99)\n   ‚Ä¢ Antioxidantes\n   ‚Ä¢ Anti-inflamatorio\n   ‚Ä¢ Uso en fr√≠o y caliente\n\n**Snacks Vegetarianos:**\nüç´ Chocolate negro 85% cacao ($4.99)\n   ‚Ä¢ Solo 3g carbos netos\n   ‚Ä¢ Rico en antioxidantes\n   ‚Ä¢ Satisface antojos\n\nüßÄ Queso de almendras ($8.99)\n   ‚Ä¢ Alternativa vegetal\n   ‚Ä¢ Cremoso y delicioso\n   ‚Ä¢ Vers√°til en recetas\n\nüí∞ **Total sugerido:** $63.94\n‚è∞ **Duraci√≥n:** 2-3 semanas\n\nüí° **Tip vegetariano:** Combina estos productos con vegetales bajos en carbos (espinacas, br√≥coli, aguacate) y prote√≠nas vegetales como tofu o tempeh.\n\n‚ú® **Importante para vegetarianos keto:**\n‚Ä¢ Asegura suficiente prote√≠na (1.6-2g por kg)\n‚Ä¢ Suplementa con B12 si eres vegano\n‚Ä¢ Var√≠a las fuentes de grasas\n‚Ä¢ Incluye omega-3 (nueces, semillas de ch√≠a)\n\n¬øQuieres que te muestre recetas vegetarianas keto para usar estos productos? ü•ó',
        trigger: {
          type: 'product',
          data: sampleProducts.slice(0, 5),
        },
      };
    }
    
    let recommendedProducts;
    
    if (isChocolateRequest) {
      recommendedProducts = sampleProducts.filter(p => 
        p.category === 'chocolates' || p.name.toLowerCase().includes('chocolate')
      );
      
      return {
        text: `¬°Los chocolates keto son mi debilidad tambi√©n! üç´ Aqu√≠ est√°n las mejores opciones:\n\n${recommendedProducts.map(p => 
          `**${p.name}** - $${p.price.toFixed(2)}\n${p.description}\nüìä ${p.nutritionInfo.calories} cal | ${p.nutritionInfo.carbs}g carbos netos | ${p.nutritionInfo.protein}g prote√≠na\n‚≠ê Perfecto para antojos de dulce sin salir de cetosis`
        ).join('\n\n')}\n\nüí° **Consejo:** El chocolate negro (>85% cacao) es ideal en keto. Aporta antioxidantes y grasas saludables.\n\n‚ú® **Dato curioso:** El chocolate keto puede ayudar a controlar antojos y evitar atracones de az√∫car regular.\n\n¬øQuieres agregarlo al carrito? Tambi√©n tengo recetas de postres keto con chocolate si te interesa. üç∞`,
        trigger: {
          type: 'product',
          data: recommendedProducts.length > 0 ? recommendedProducts : sampleProducts.slice(0, 2),
        },
      };
    } else if (isSnackRequest) {
      recommendedProducts = sampleProducts.slice(0, 4);
      
      return {
        text: `¬°Los snacks keto son esenciales para el √©xito! Aqu√≠ est√°n mis favoritos: üéØ\n\n${recommendedProducts.map(p => 
          `üõí **${p.name}** - $${p.price.toFixed(2)}\n   ${p.description}\n   üìä ${p.nutritionInfo.calories} cal | ${p.nutritionInfo.carbs}g carbos | ${p.nutritionInfo.protein}g prote√≠na\n   ‚ú® Ideal para: ${p.category === 'snacks' ? 'Media ma√±ana/tarde' : 'Cualquier momento'}`
        ).join('\n\n')}\n\nüí° **Tips para snacking keto:**\n1. Ten snacks siempre a mano (evita tentaciones)\n2. Lee etiquetas (algunos "keto" no lo son)\n3. Controla porciones (incluso en keto)\n4. Prioriza snacks con prote√≠na (m√°s saciantes)\n\n**¬øSab√≠as que?** Los mejores snacks keto combinan grasa + prote√≠na para saciedad duradera.\n\n¬øQuieres que te ayude a armar un paquete de snacks variados para la semana? üì¶`,
        trigger: {
          type: 'product',
          data: recommendedProducts,
        },
      };
    } else {
      recommendedProducts = sampleProducts.slice(0, 5);
      
      return {
        text: `¬°Genial! Tenemos productos keto de alta calidad para hacer tu vida m√°s f√°cil. üõçÔ∏è\n\n**Categor√≠as disponibles:**\n\n${recommendedProducts.map(p => 
          `üõí **${p.name}** - $${p.price.toFixed(2)}\n   ${p.description}\n   üìä ${p.nutritionInfo.calories} cal | ${p.nutritionInfo.carbs}g carbos | ${p.nutritionInfo.fat}g grasas`
        ).join('\n\n')}\n\n‚ú® **Todos nuestros productos son:**\n‚Ä¢ Bajos en carbohidratos (<5g netos)\n‚Ä¢ Sin az√∫cares a√±adidos\n‚Ä¢ Sin ingredientes artificiales\n‚Ä¢ Certificados keto-friendly\n\nüí° **Recomendaci√≥n:** Combina productos con recetas caseras para variedad y ahorro.\n\n¬øQuieres ver m√°s detalles de alguno o prefieres que te ayude a armar un paquete personalizado? Tambi√©n puedo mostrarte recetas que usan estos productos. üòä`,
        trigger: {
          type: 'product',
          data: recommendedProducts,
        },
      };
    }
  }

  // Forum post citations - Enhanced community integration
  if (/(foro|comunidad|post|discusi√≥n|opiniones|experiencias|qu√© dicen|otros usuarios)/i.test(lower)) {
    const isAboutRecipes = /(receta|cocinar|comida)/i.test(lower);
    const isAboutExercise = /(ejercicio|gym|fitness|deporte)/i.test(lower);
    const isAboutMotivation = /(motivaci√≥n|√°nimo|apoyo|experiencia)/i.test(lower);
    
    const relevantPosts = forumPosts.filter(p => {
      if (isAboutRecipes) return p.communityId === 'healthy-foodies';
      if (isAboutExercise) return p.communityId === 'fitness-tribe';
      if (isAboutMotivation) return p.communityId === 'healthy-mind';
      return true;
    }).slice(0, 3);

    if (relevantPosts.length > 0) {
      const forumSummary = relevantPosts.map((p, idx) => 
        `**${idx + 1}. ${p.title}**\n   üë§ Por: ${p.username}\n   ü§ñ Resumen IA: ${p.aiSummary}\n   üëç ${p.upvotes} votos | üí¨ ${p.commentCount} comentarios`
      ).join('\n\n');

      const categoryName = isAboutRecipes ? 'recetas keto' : isAboutExercise ? 'ejercicio y fitness' : 'experiencias y motivaci√≥n';

      return {
        text: `¬°Excelente pregunta! La comunidad tiene mucho que compartir sobre ${categoryName}. üí¨\n\nEstas son las discusiones m√°s relevantes:\n\n${forumSummary}\n\nüí° **Por qu√© me gusta nuestra comunidad:**\n‚Ä¢ Experiencias reales de personas como t√∫\n‚Ä¢ Apoyo mutuo y motivaci√≥n\n‚Ä¢ Tips y trucos probados\n‚Ä¢ Recetas compartidas por usuarios\n\nüéØ **Dato interesante:** Los usuarios que participan en la comunidad tienen 3x m√°s probabilidad de mantener sus resultados a largo plazo.\n\n¬øTe gustar√≠a que te muestre m√°s detalles de alguna discusi√≥n? Tambi√©n puedes compartir tu propia experiencia. ¬°La comunidad te apoyar√°! üíö`,
        trigger: {
          type: 'forum',
          data: relevantPosts,
        },
      };
    }
  }
  
  // Macro calculation and meal planning
  if (/(macro|calcular|cu√°nto|necesito|calor√≠as|prote√≠na|grasa|carbohidrato)/i.test(lower)) {
    if (/(peso|altura|edad|actividad)/i.test(lower) || conversationHistory.length >= 2) {
      return {
        text: '¬°Perfecto! Para calcular tus macros personalizados necesito algunos datos b√°sicos. üìä\n\n**Calculadora de Macros Keto:**\n\n**Informaci√≥n necesaria:**\n1Ô∏è‚É£ **Edad**: a√±os\n2Ô∏è‚É£ **Sexo**: M/F\n3Ô∏è‚É£ **Peso actual**: kg\n4Ô∏è‚É£ **Altura**: cm\n5Ô∏è‚É£ **Nivel de actividad**:\n   ‚Ä¢ Sedentario (trabajo de oficina)\n   ‚Ä¢ Ligero (ejercicio 1-3 d√≠as/semana)\n   ‚Ä¢ Moderado (ejercicio 3-5 d√≠as/semana)\n   ‚Ä¢ Activo (ejercicio 6-7 d√≠as/semana)\n6Ô∏è‚É£ **Objetivo**:\n   ‚Ä¢ P√©rdida de peso (-)\n   ‚Ä¢ Mantenimiento (=)\n   ‚Ä¢ Ganancia muscular (+)\n\n**Ejemplo de resultado (mujer, 30 a√±os, 70kg, sedentaria, p√©rdida de peso):**\n\nüìä **Macros Diarios:**\n‚Ä¢ Calor√≠as: 1,400 kcal\n‚Ä¢ Prote√≠na: 105g (30%)\n‚Ä¢ Grasas: 109g (70%)\n‚Ä¢ Carbos: 20g netos (5%)\n\n**Distribuci√≥n sugerida:**\nüç≥ Desayuno: 400 kcal (30g prote√≠na, 30g grasa)\nü•ó Almuerzo: 500 kcal (40g prote√≠na, 40g grasa)\nüçñ Cena: 500 kcal (35g prote√≠na, 39g grasa)\n\nüí° **Tips importantes:**\n1. Prote√≠na es PRIORITARIA (preserva m√∫sculo)\n2. Grasas para saciedad (no temas comerlas)\n3. Carbos son L√çMITE (no objetivo a alcanzar)\n4. Ajusta seg√∫n energ√≠a y resultados\n\n¬øQuieres que un nutricionista calcule tus macros exactos y cree un plan personalizado? Es mucho m√°s preciso. üéØ',
        trigger: {
          type: 'nutritionist',
          data: nutritionists[0],
        },
      };
    }
    
    return {
      text: 'Claro, puedo ayudarte a entender tus macros keto. üìä\n\n**Los macros keto b√°sicos son:**\n\nü•ë **Grasas: 70-75%** de calor√≠as totales\n‚Ä¢ Energ√≠a principal en keto\n‚Ä¢ Saciedad y absorci√≥n de vitaminas\n\nü•© **Prote√≠na: 20-25%** de calor√≠as totales\n‚Ä¢ Preserva masa muscular\n‚Ä¢ Aprox. 1.6-2g por kg de peso ideal\n\nü•¨ **Carbohidratos: 5-10%** (20-30g netos/d√≠a)\n‚Ä¢ Mayormente de vegetales\n‚Ä¢ "Netos" = total - fibra\n\n**Ejemplo pr√°ctico (1,600 kcal/d√≠a):**\n‚Ä¢ Grasas: 124g (1,120 kcal)\n‚Ä¢ Prote√≠na: 100g (400 kcal)\n‚Ä¢ Carbos: 20g (80 kcal)\n\nPara darte n√∫meros exactos personalizados, necesito saber:\n‚Ä¢ Tu peso y altura\n‚Ä¢ Nivel de actividad\n‚Ä¢ Objetivo (bajar/mantener/ganar)\n\n¬øMe compartes esos datos para calcular TUS macros espec√≠ficos? üòä',
    };
  }

  // Keto flu and side effects
  if (/(gripe|s√≠ntoma|dolor|cabeza|cansancio|mareado|calambres|electrolito)/i.test(lower)) {
    return {
      text: '¬°Ah, la famosa "gripe keto"! Es totalmente normal y temporal. Te explico: ü§í\n\n**¬øQu√© es la gripe keto?**\nCuando tu cuerpo cambia de glucosa a cetonas como combustible, puede experimentar s√≠ntomas de adaptaci√≥n.\n\n**S√≠ntomas comunes (d√≠as 2-7):**\nüò´ Dolor de cabeza\nüò¥ Fatiga y cansancio\nü§¢ N√°useas leves\nüí™ Calambres musculares\nüß† "Brain fog" (mente nublada)\nüò† Irritabilidad\n\n**LA SOLUCI√ìN (muy importante):**\n\nüßÇ **ELECTROLITOS**\n\n**Sodio:**\n‚Ä¢ 5,000-7,000mg/d√≠a (2-3 cucharaditas de sal)\n‚Ä¢ A√±ade sal a todo\n‚Ä¢ Caldo de huesos\n\n**Magnesio:**\n‚Ä¢ 400-500mg/d√≠a\n‚Ä¢ Suplemento o aguacate/espinacas/nueces\n\n**Potasio:**\n‚Ä¢ 3,000-4,000mg/d√≠a\n‚Ä¢ Aguacate, espinacas, salm√≥n\n\nüíß **Hidrataci√≥n:**\n‚Ä¢ 2.5-4L agua/d√≠a\n‚Ä¢ M√°s de lo normal (keto libera agua)\n\n‚ö° **Energ√≠a:**\n‚Ä¢ MCT oil o aceite de coco\n‚Ä¢ Caf√© bulletproof\n‚Ä¢ Descanso adecuado\n\n**Timeline de mejora:**\nüìÖ D√≠a 3-5: Pico de s√≠ntomas\nüìÖ D√≠a 7-10: Mejora significativa\nüìÖ D√≠a 14+: Energ√≠a aumenta\nüìÖ Semana 3-4: Adaptaci√≥n completa\n\nüí° **CRUCIAL:** La gripe keto es 90% falta de electrolitos. Aumenta sal AHORA y ver√°s mejora en 24-48h.\n\n¬øNecesitas recetas de bebidas electrol√≠ticas caseras o prefieres que te muestre productos? ü•§',
    };
  }

  // Dining out and social situations
  if (/(restaurante|salir|comer fuera|fiesta|reuni√≥n|social)/i.test(lower)) {
    return {
      text: '¬°Excelente pregunta! Mantener keto en situaciones sociales es totalmente posible. Te doy mi gu√≠a completa: üçΩÔ∏è\n\n**RESTAURANTES - Gu√≠a por tipo:**\n\n**ü•© Steakhouse/Parrilla**\n‚úÖ Ordenar: Carne + vegetales + ensalada\n‚úÖ Pedir: Mantequilla extra\n‚ùå Evitar: Papas, pan, salsas dulces\nüí° Tip: Pide que no traigan pan a la mesa\n\n**üçù Italiano**\n‚úÖ Ordenar: Pollo/pescado a la plancha, ensalada caprese\n‚úÖ Pedir: Extra aceite de oliva\n‚ùå Evitar: Pasta, pizza, pan de ajo\nüí° Tip: Algunos ofrecen "pasta" de calabac√≠n\n\n**üåÆ Mexicano**\n‚úÖ Ordenar: Fajitas (sin tortilla), guacamole, pico de gallo\n‚úÖ Pedir: Ensalada bowl en vez de burrito\n‚ùå Evitar: Tortillas, arroz, frijoles refritos\nüí° Tip: Chicharr√≥n en vez de totopos\n\n**üç£ Japon√©s**\n‚úÖ Ordenar: Sashimi, edamame, algas\n‚úÖ Pedir: Salsa de soya, wasabi\n‚ùå Evitar: Arroz, tempura, rolls con arroz\nüí° Tip: Naruto rolls (envueltos en pepino)\n\n**FIESTAS Y REUNIONES:**\n\n**Antes de ir:**\n1. Come algo antes (no llegues con hambre)\n2. Lleva tu propio snack keto\n3. Avisa al anfitri√≥n (opcional)\n\n**En la fiesta:**\n‚úÖ Buscar: Quesos, embutidos, vegetales, nueces\n‚úÖ Beber: Agua, vino seco, licor con soda\n‚ùå Evitar: Pan, postres, cerveza, jugos\n\n**Respuestas a preguntas comunes:**\n"¬øNo comes pan?" ‚Üí "Estoy evitando carbohidratos"\n"¬øPor qu√© no comes postre?" ‚Üí "Estoy cuidando mi salud"\n"¬øSolo eso comes?" ‚Üí "Prefiero prote√≠na y vegetales"\n\nüí° **Tip PRO:** Nadie nota realmente qu√© comes. La gente est√° enfocada en s√≠ misma.\n\n**Bebidas alcoh√≥licas keto:**\n‚úÖ Whisky, vodka, tequila (puros)\n‚úÖ Vino tinto seco (copa)\n‚úÖ Champagne brut\n‚ùå Cerveza, cocteles dulces, licores cremosos\n\n¬øNecesitas m√°s tips para alguna situaci√≥n espec√≠fica? üòä',
    };
  }

  // Recipe requests - Enhanced with context awareness
  if (/(receta|cocinar|preparar|desayuno|almuerzo|cena|comida)/i.test(lower) || 
      (/(pasos|c√≥mo|preparaci√≥n|instrucciones|detalle|dame.*pasos|dame.*primera)/i.test(lower) && context.hasAskedAboutRecipes)) {
    
    // Detailed recipe follow-up if user asks for steps
    if (/(pasos|c√≥mo.*prepar|instrucciones|detalle|dame.*pasos|dame.*de la primera|dame los pasos)/i.test(lower)) {
      return {
        text: '¬°Claro! Te doy los pasos completos de la primera receta:\n\n**üç≥ Huevos Revueltos Gourmet con Aguacate**\n\n**Ingredientes:**\n‚Ä¢ 3 huevos org√°nicos\n‚Ä¢ 1/2 aguacate maduro\n‚Ä¢ 2 cucharadas de queso crema\n‚Ä¢ 2 tiras de tocino crujiente\n‚Ä¢ 1 pu√±ado de espinacas baby\n‚Ä¢ Sal y pimienta al gusto\n‚Ä¢ 1 cucharada de mantequilla\n\n**Preparaci√≥n (10 minutos):**\n\n1Ô∏è‚É£ **Prepara el tocino**: Cocina el tocino hasta que est√© crujiente (5 min), luego c√≥rtalo en trocitos\n\n2Ô∏è‚É£ **Bate los huevos**: En un bowl, bate los 3 huevos con sal y pimienta hasta que est√©n bien mezclados\n\n3Ô∏è‚É£ **Cocina las espinacas**: En la misma sart√©n del tocino, saltea las espinacas 1 minuto hasta que se ablanden. Reserva.\n\n4Ô∏è‚É£ **Revuelve los huevos**: Calienta la mantequilla a fuego medio, agrega los huevos y revuelve suavemente con esp√°tula\n\n5Ô∏è‚É£ **Termina el platillo**: Cuando los huevos est√©n casi listos (cremosos), a√±ade el queso crema, tocino y espinacas. Mezcla 30 segundos m√°s.\n\n6Ô∏è‚É£ **Sirve**: Coloca en un plato y acompa√±a con aguacate en rodajas al lado\n\nüí° **Tips del chef:**\n‚Ä¢ No sobre cocines los huevos (deben quedar cremosos, no secos)\n‚Ä¢ El aguacate aporta grasas saludables y cremosidad\n‚Ä¢ Puedes agregar queso rallado encima\n‚Ä¢ Sirve caliente para mejor sabor\n\nüìä **Macros totales:** 5g carbos netos | 30g prote√≠na | 35g grasas | 450 kcal\n\n‚ú® Esta es una de las recetas favoritas de la comunidad. ¬°Perfecta para empezar el d√≠a con energ√≠a!\n\n¬øQuieres que te recomiende productos keto para complementar esta receta o ver m√°s opciones de desayuno? ü•ë',
      };
    }
    
    const mealType = 
      /(desayuno|breakfast)/i.test(lower) ? 'desayuno' :
      /(almuerzo|lunch|comida)/i.test(lower) ? 'almuerzo' :
      /(cena|dinner)/i.test(lower) ? 'cena' : 'cualquier momento';
    
    const isVegetarian = context.mentionedVegetarian;
    const isForSports = context.mentionedSports || /(pre-entreno|post-entreno|antes del gym|despu√©s del gym|qu√©.*comer.*gym|qu√©.*comer.*ejercicio)/i.test(lower);
    const isEasy = /(f√°cil|r√°pido|simple|sencillo)/i.test(lower) && !isForSports;

    // Vegetarian recipes
    if (isVegetarian) {
      return {
        text: `¬°Perfecto! Tengo opciones vegetarianas keto deliciosas para ${mealType}! ü•ó\n\n**Opci√≥n 1: Bowl de Tofu Scramble**\n‚Ä¢ Tofu firme desmenuzado\n‚Ä¢ Espinacas baby\n‚Ä¢ Champi√±ones salteados\n‚Ä¢ Aguacate\n‚Ä¢ Semillas de hemp\nüìä 7g carbos | 20g prote√≠na | 28g grasas\nüå± Alto en prote√≠na vegetal\n\n**Opci√≥n 2: Ensalada Mediterr√°nea Keto**\n‚Ä¢ Mix de lechugas\n‚Ä¢ Queso feta\n‚Ä¢ Aceitunas kalamata\n‚Ä¢ Pepino y tomate cherry\n‚Ä¢ Aderezo de aceite de oliva\nüìä 6g carbos | 12g prote√≠na | 35g grasas\nü•ó Fresca y saciante\n\n**Opci√≥n 3: Panqueques de Almendra**\n‚Ä¢ Harina de almendra\n‚Ä¢ Huevos\n‚Ä¢ Mantequilla de almendra\n‚Ä¢ Stevia y canela\nüìä 5g carbos | 18g prote√≠na | 30g grasas\nü•û Perfecto para desayuno dulce\n\n¬øCu√°l te llama m√°s la atenci√≥n? ¬°Puedo darte los pasos detallados! üòä`,
        trigger: {
          type: 'recipe',
          data: { mealType, vegetarian: true },
        },
      };
    }

    // Sports/performance recipes
    if (isForSports) {
      return {
        text: `¬°Genial! Como atleta/deportista, necesitas recetas que optimicen tu rendimiento. üí™\n\n**Pre-Entreno (30-60 min antes):**\n\n**Caf√© Bulletproof Mejorado**\n‚Ä¢ Caf√© negro\n‚Ä¢ 1 cucharada MCT oil\n‚Ä¢ 1 cucharada mantequilla grass-fed\n‚Ä¢ Col√°geno en polvo (opcional)\nüìä 1g carbos | 15g prote√≠na | 30g grasas\n‚ö° Energ√≠a sostenida sin crash\n\n**Post-Entreno (dentro de 2 horas):**\n\n**Bowl de Recuperaci√≥n**\n‚Ä¢ 150g pollo o salm√≥n\n‚Ä¢ Espinacas salteadas en aceite de coco\n‚Ä¢ Aguacate\n‚Ä¢ Nueces picadas\n‚Ä¢ Semillas de ch√≠a\nüìä 8g carbos | 40g prote√≠na | 35g grasas\nüèãÔ∏è √ìptimo para recuperaci√≥n muscular\n\n**Snack R√°pido:**\n\n**Fat Bombs Energ√©ticas**\n‚Ä¢ Mantequilla de almendra\n‚Ä¢ Aceite de coco\n‚Ä¢ Cacao puro\n‚Ä¢ Stevia\n‚Ä¢ Sal marina\nüìä 3g carbos | 5g prote√≠na | 25g grasas\nüéØ Ideal para energ√≠a r√°pida\n\nüí° **Consejo Pro:** Las grasas MCT son ideales para deportistas keto porque se convierten r√°pidamente en energ√≠a.\n\n¬øQuieres que te conecte con nuestro nutricionista deportivo para un plan personalizado? üèÉ‚Äç‚ôÇÔ∏è`,
        trigger: {
          type: 'recipe',
          data: { mealType, sports: true },
        },
      };
    }

    // Easy/quick recipes
    if (isEasy) {
      return {
        text: `¬°Entiendo! Aqu√≠ est√°n mis recetas keto m√°s r√°pidas y f√°ciles (menos de 10 minutos): ‚ö°\n\n**1. Ensalada Express (3 min)**\n‚Ä¢ Mix de lechugas pre-lavadas\n‚Ä¢ At√∫n en lata\n‚Ä¢ Aguacate en cubos\n‚Ä¢ Aceite de oliva y lim√≥n\nüìä 4g carbos | 30g prote√≠na | 25g grasas\n‚ú® Solo mezclar, sin cocinar\n\n**2. Omelette Microondas (2 min)**\n‚Ä¢ 2 huevos batidos en taza\n‚Ä¢ Queso rallado\n‚Ä¢ Jam√≥n picado\n‚Ä¢ Microondas 90 segundos\nüìä 2g carbos | 25g prote√≠na | 20g grasas\nüî• S√∫per r√°pido para d√≠as ocupados\n\n**3. Plato de Embutidos y Queso (1 min)**\n‚Ä¢ Salami, pepperoni\n‚Ä¢ Quesos variados\n‚Ä¢ Aceitunas\n‚Ä¢ Nueces\nüìä 3g carbos | 20g prote√≠na | 35g grasas\nüßÄ Perfecto para cuando tienes prisa\n\nüí° **Tip:** Puedes hacer meal prep los domingos y tener estas opciones listas en el refrigerador toda la semana.\n\n¬øTe interesa ver productos keto que puedes comprar ya preparados para facilitarte a√∫n m√°s la vida? üõí`,
        trigger: {
          type: 'recipe',
          data: { mealType, quick: true },
        },
      };
    }

    // Default comprehensive recipes
    return {
      text: `¬°Tengo deliciosas recetas keto para ${mealType}! Preparadas pensando en m√°xima nutrici√≥n y sabor üç≥\n\n**Opci√≥n 1: Huevos Revueltos Gourmet**\n‚Ä¢ 3 huevos org√°nicos\n‚Ä¢ 1/2 aguacate\n‚Ä¢ Queso crema\n‚Ä¢ Tocino crujiente\n‚Ä¢ Espinacas baby\nüìä 5g carbos | 30g prote√≠na | 35g grasas\n‚≠ê Favorita de la comunidad\n\n**Opci√≥n 2: Salm√≥n con Vegetales Asados**\n‚Ä¢ Filete de salm√≥n\n‚Ä¢ Br√≥coli y esp√°rragos\n‚Ä¢ Mantequilla de ajo\n‚Ä¢ Lim√≥n\nüìä 6g carbos | 35g prote√≠na | 28g grasas\nüêü Alto en Omega-3\n\n**Opci√≥n 3: Ensalada C√©sar Keto**\n‚Ä¢ Lechuga romana\n‚Ä¢ Pollo a la plancha\n‚Ä¢ Parmesano\n‚Ä¢ Aderezo c√©sar casero\n‚Ä¢ Tocino bits\nüìä 7g carbos | 32g prote√≠na | 30g grasas\nü•ó Cl√°sica y saciante\n\n¬øTe interesa ver los pasos detallados de alguna? O si prefieres, puedo mostrarte productos keto relacionados que tenemos en la tienda. üòä`,
      trigger: {
        type: 'recipe',
        data: { mealType },
      },
    };
  }

  // Weight loss - Multi-turn natural conversation with context
  if (/(bajar|peso|adelgazar|perder|delgad|obesidad)/i.test(lower)) {
    // Second interaction - provide detailed plan (detect when user shares specific details)
    if (context.hasSharedGoals && context.hasSharedRestrictions && conversationHistory.length >= 2) {
      return {
        text: '¬°Excelente! Con esta informaci√≥n puedo ayudarte mucho mejor. Aqu√≠ est√° tu plan inicial personalizado: üìã\n\n**üéØ Plan Keto Personalizado para P√©rdida de Peso**\n\n**Fase 1: Adaptaci√≥n (Semanas 1-2)**\n‚Ä¢ Objetivo: Entrar en cetosis\n‚Ä¢ Carbos: <20g netos/d√≠a\n‚Ä¢ Enf√≥cate en alimentos naturales\n‚Ä¢ Bebe 2-3L de agua diaria\n‚Ä¢ Electrolitos: sal, magnesio, potasio\n\n**Fase 2: Optimizaci√≥n (Semanas 3-8)**\n‚Ä¢ Objetivo: P√©rdida de peso sostenida\n‚Ä¢ Carbos: 20-30g netos/d√≠a\n‚Ä¢ Ayuno intermitente 16:8 (opcional)\n‚Ä¢ Incorpora ejercicio ligero\n‚Ä¢ Mide progreso (no solo balanza)\n\n**Fase 3: Mantenimiento (Mes 3+)**\n‚Ä¢ Objetivo: Mantener resultados\n‚Ä¢ Carbos: 30-50g netos/d√≠a (personalizado)\n‚Ä¢ Estilo de vida, no dieta temporal\n‚Ä¢ Flexibilidad controlada\n\nüìä **Macros sugeridos:**\n‚Ä¢ Prote√≠na: 1.6-2g por kg de peso ideal\n‚Ä¢ Grasas: 70-75% de calor√≠as totales\n‚Ä¢ Carbos: <20g netos en fase inicial\n\nüí° **Expectativas realistas:**\n‚Ä¢ Semana 1-2: 2-4 kg (mayormente agua)\n‚Ä¢ Despu√©s: 0.5-1 kg por semana\n‚Ä¢ Mesetas son normales (no te desanimes)\n\n**¬øQu√© te gustar√≠a hacer ahora?**\n\na) Ver recetas espec√≠ficas para bajar de peso\nb) Conocer productos keto que te faciliten el proceso\nc) Hablar con un nutricionista para un plan m√°s personalizado\n\n¬°T√∫ decides! üíö',
        trigger: {
          type: 'nutritionist',
          data: nutritionists.find(n => n.id === 'n3'),
        },
      };
    }
    
    // First interaction - gather information
    if (!context.hasSharedGoals || conversationHistory.length < 3) {
      return {
        text: '¬°Perfecto! Me encanta que quieras mejorar tu salud. La dieta keto es incre√≠blemente efectiva para p√©rdida de peso saludable. üí™\n\n**Antes de crear tu plan personalizado, cu√©ntame un poco sobre ti:**\n\n1Ô∏è‚É£ ¬øCu√°nto peso te gustar√≠a perder?\n2Ô∏è‚É£ ¬øEn qu√© plazo? (sin prisa, lo importante es ser saludable)\n3Ô∏è‚É£ ¬øTienes alguna restricci√≥n alimenticia? (vegetariano, alergias, etc.)\n4Ô∏è‚É£ ¬øHaces ejercicio actualmente?\n\nNo te preocupes si no tienes todas las respuestas ahora, podemos ir paso a paso. ¬øPor d√≥nde te gustar√≠a empezar? üòä',
      };
    }
    
    // Third interaction - offer professional help
    return {
      text: 'Veo que realmente est√°s comprometido con tu objetivo. ¬°Eso es genial! üåü\n\n**Para llevarte al siguiente nivel**, te recomiendo considerar una consulta con un nutricionista especializado en keto y p√©rdida de peso.\n\n**¬øPor qu√© un profesional?**\n\n‚úÖ Plan 100% personalizado a tu metabolismo\n‚úÖ Ajustes basados en tu progreso real\n‚úÖ An√°lisis de composici√≥n corporal\n‚úÖ Apoyo cuando tengas dudas o mesetas\n‚úÖ Estrategias para mantener resultados largo plazo\n\nTengo el nutricionista perfecto para ti:\n\n**Lic. Ana Rodr√≠guez** - Especialista en P√©rdida de Peso Saludable\n‚≠ê 4.9/5.0 (142 rese√±as)\nüíº 8 a√±os de experiencia\nüéì Certificada en Nutrici√≥n Cetog√©nica\nüíµ $45 USD/sesi√≥n\n\nüìä **Lo que dicen sus pacientes:**\n"Perd√≠ 15kg en 4 meses de forma saludable"\n"Muy profesional y emp√°tica"\n"Me ense√±√≥ a mantener mi peso ideal"\n\n¬øTe gustar√≠a agendar una cita con ella? Tambi√©n puedo seguir ayud√°ndote con el plan gratuito, ¬°lo que prefieras! üòä',
      trigger: {
        type: 'nutritionist',
        data: nutritionists.find(n => n.id === 'n3'),
      },
    };
  }

  // Tips and advice - Context-aware and comprehensive
  if (/(consejo|tip|recomendaci√≥n|ayuda|sugerencia|c√≥mo|mejor manera)/i.test(lower)) {
    // Specific tips based on context
    if (/(empezar|comenzar|inicio|principiante)/i.test(lower)) {
      return {
        text: '¬°Claro! Aqu√≠ est√° mi gu√≠a de inicio para principiantes en keto: üöÄ\n\n**SEMANA 1: Preparaci√≥n y Adaptaci√≥n**\n\n**D√≠a 1-2: Limpieza**\n‚Ä¢ Saca de casa: az√∫car, pan, pasta, arroz\n‚Ä¢ Compra: huevos, carne, queso, aguacate, vegetales\n‚Ä¢ Aprende: a leer etiquetas (carbos netos)\n\n**D√≠a 3-5: Adaptaci√≥n**\n‚Ä¢ S√≠ntomas: posible "gripe keto"\n‚Ä¢ Soluci√≥n: ELECTROLITOS (sal, magnesio, potasio)\n‚Ä¢ Expectativa: p√©rdida de peso de agua (normal)\n\n**D√≠a 6-7: Ajuste**\n‚Ä¢ Calcula tus macros\n‚Ä¢ Planifica comidas de la pr√≥xima semana\n‚Ä¢ √önete a comunidad para apoyo\n\n**5 REGLAS DE ORO:**\n\n1Ô∏è‚É£ **Mant√©n carbos <20g netos/d√≠a**\n   Netos = totales - fibra\n\n2Ô∏è‚É£ **Prioriza prote√≠na**\n   1.6-2g por kg de peso ideal\n\n3Ô∏è‚É£ **No temas a las grasas**\n   Son tu nueva fuente de energ√≠a\n\n4Ô∏è‚É£ **ELECTROLITOS diarios**\n   Sal, magnesio, potasio\n\n5Ô∏è‚É£ **Hidr√°tate**\n   2.5-4L agua/d√≠a\n\n**ERRORES COMUNES A EVITAR:**\n\n‚ùå No comer suficiente sal\n‚ùå Comer "productos keto" procesados\n‚ùå No dormir suficiente\n‚ùå Compararte con otros\n‚ùå Rendirte en la semana 1\n\n**TU PRIMERA COMPRA:**\n‚Ä¢ Huevos (2-3 docenas)\n‚Ä¢ Mantequilla/aceite de coco\n‚Ä¢ Carne molida\n‚Ä¢ Pollo\n‚Ä¢ Aguacates\n‚Ä¢ Espinacas/lechuga\n‚Ä¢ Quesos\n‚Ä¢ Sal del Himalaya\n\nüí∞ Presupuesto: $50-70 USD para la semana\n\nüí° **Mi mejor consejo:** Los primeros 3-4 d√≠as son los m√°s dif√≠ciles. Despu√©s de eso, tu energ√≠a aumenta y los antojos desaparecen. ¬°Vale la pena!\n\n¬øQuieres que te arme un men√∫ completo para tu primera semana? üìÖ',
      };
    }
    
    if (/(ejercicio|gym|entrenar|fitness)/i.test(lower)) {
      return {
        text: 'üí™ ¬°Excelente! Keto y ejercicio son una combinaci√≥n poderosa. Aqu√≠ est√° todo lo que necesitas saber:\n\n**ADAPTACI√ìN KETO + EJERCICIO**\n\n**Semanas 1-3: Fase de Adaptaci√≥n**\n‚Ä¢ Reduce intensidad 20-30%\n‚Ä¢ Enf√≥cate en t√©cnica\n‚Ä¢ Tu cuerpo est√° aprendiendo a usar grasa\n‚Ä¢ Es NORMAL sentirte con menos fuerza\n\n**Semanas 4-8: Recuperaci√≥n**\n‚Ä¢ Aumenta intensidad gradualmente\n‚Ä¢ Fuerza regresa a niveles normales\n‚Ä¢ Resistencia mejora significativamente\n\n**Semana 8+: Keto-Adaptado**\n‚Ä¢ Energ√≠a sostenida (sin crashes)\n‚Ä¢ Menos inflamaci√≥n\n‚Ä¢ Recuperaci√≥n m√°s r√°pida\n‚Ä¢ Composici√≥n corporal mejora\n\n**NUTRICI√ìN PRE/POST ENTRENO:**\n\n**30-60 min ANTES:**\n‚òï Caf√© negro + MCT oil\nü•ë Medio aguacate\nüßÄ Queso + nueces\nüí° Objetivo: Energ√≠a sin peso en est√≥mago\n\n**DURANTE (>1 hora):**\nüíß Agua con electrolitos\nüßÇ Sal marina\nüçã Lim√≥n (opcional)\n\n**DESPU√âS (dentro de 2h):**\nüçñ Prote√≠na (30-40g)\nü•ë Grasas saludables\nü•¨ Vegetales\nüí° Objetivo: Recuperaci√≥n muscular\n\n**SUPLEMENTOS √öTILES:**\n\n‚úÖ **Electrolitos**\n   Esencial, no opcional\n\n‚úÖ **MCT Oil**\n   Energ√≠a r√°pida para entrenar\n\n‚úÖ **Creatina**\n   Compatible con keto\n\n‚úÖ **BCAA** (opcional)\n   Si entrenas en ayunas\n\n‚ö†Ô∏è **Beta-Alanina, Carbos intra-entreno**\n   No necesarios en keto\n\n**POR TIPO DE EJERCICIO:**\n\nüèãÔ∏è **Pesas/Fuerza:**\n‚Ä¢ Excelente en keto\n‚Ä¢ Mant√©n prote√≠na alta\n‚Ä¢ Paciencia en adaptaci√≥n\n\nüèÉ **Cardio/Resistencia:**\n‚Ä¢ Mejora despu√©s de adaptaci√≥n\n‚Ä¢ Quema grasa eficientemente\n‚Ä¢ Menos dependencia de carbos\n\nüî• **HIIT:**\n‚Ä¢ Reduce frecuencia al inicio\n‚Ä¢ Aumenta despu√©s de 4-6 semanas\n‚Ä¢ Electrolitos extra\n\n‚ö° **CrossFit/Alta Intensidad:**\n‚Ä¢ Considera TKD (Targeted Keto Diet)\n‚Ä¢ 15-30g carbos pre-entreno\n‚Ä¢ Solo si es muy intenso\n\nüí° **Mi consejo PRO:** La adaptaci√≥n toma tiempo. No juzgues keto por las primeras 3 semanas. Dale 6-8 semanas y ser√°s un m√°quina de quemar grasa.\n\n¬øQuieres hablar con nuestro nutricionista deportivo para un plan personalizado? üéØ',
      };
    }
    
    // General rotating tips
    const generalTips = [
      'üí° **Hack de Hidrataci√≥n**\n\nEn keto, necesitas M√ÅS agua que antes porque:\n‚Ä¢ Menos insulina = menos retenci√≥n de agua\n‚Ä¢ Cetonas se excretan por orina\n‚Ä¢ Electrolitos se pierden m√°s r√°pido\n\n**Mi f√≥rmula:**\nüíß Peso (kg) x 0.033 = Litros/d√≠a\nEjemplo: 70kg x 0.033 = 2.3L m√≠nimo\n\n**Se√±ales de deshidrataci√≥n:**\n‚Ä¢ Orina amarilla oscura\n‚Ä¢ Dolor de cabeza\n‚Ä¢ Fatiga\n‚Ä¢ Estre√±imiento\n\n**Soluci√≥n simple:**\nBotella de 1L siempre contigo. Llena 2-3 veces al d√≠a.\n\nüíß ¬øSab√≠as que? Muchos "antojos" son en realidad sed disfrazada.',
      
      'üí° **Meal Prep Domingos**\n\n¬øCansado de cocinar diario? Aqu√≠ mi sistema:\n\n**DOMINGO (2-3 horas):**\n\n**Prote√≠nas:**\n‚Ä¢ 1kg pollo horneado con especias\n‚Ä¢ 1kg carne molida cocida\n‚Ä¢ 12 huevos duros\n\n**Vegetales:**\n‚Ä¢ Br√≥coli y coliflor al vapor\n‚Ä¢ Ensalada verde (sin aderezar)\n‚Ä¢ Espinacas salteadas en aceite de coco\n\n**Grasas:**\n‚Ä¢ Aderezo casero (aceite + vinagre + especias)\n‚Ä¢ Porci√≥n de nueces en bolsitas\n‚Ä¢ Aguacates (comprar d√≠a a d√≠a)\n\n**Almacenamiento:**\nüì¶ Contenedores de vidrio\n‚ùÑÔ∏è Refrigerador: 4-5 d√≠as\nüßä Congelador: el resto\n\n**Lunes-Viernes:**\n‚ö° 5 minutos: Combina prote√≠na + vegetal + grasa\n‚úÖ Comida lista sin pensar\n\nüí∞ Ahorro: $100+ USD/mes vs comer fuera\n‚è∞ Ahorro: 1-2 horas/d√≠a\n\n¬øNecesitas recetas espec√≠ficas para meal prep? ü•ò',
      
      'üí° **El Poder del Ayuno Intermitente**\n\nKeto + Ayuno Intermitente = S√∫per combo üöÄ\n\n**¬øPor qu√© funcionan tan bien juntos?**\n‚Ä¢ Keto ya reduce hambre\n‚Ä¢ Tu cuerpo usa grasa 24/7\n‚Ä¢ Cetonas suprimen apetito\n‚Ä¢ Energ√≠a estable todo el d√≠a\n\n**Protocolos populares:**\n\n‚è∞ **16:8 (principiantes)**\nComer: 12pm - 8pm\nAyuno: 8pm - 12pm\nüí° M√°s f√°cil: solo salta desayuno\n\n‚è∞ **18:6 (intermedio)**\nComer: 2pm - 8pm\nAyuno: 8pm - 2pm\nüí° Mayor beneficio metab√≥lico\n\n‚è∞ **20:4 (avanzado)**\nComer: 4pm - 8pm\nAyuno: 8pm - 4pm\nüí° Solo si te sientes bien\n\n‚è∞ **OMAD (una comida al d√≠a)**\nComer: 1 comida\nAyuno: 23 horas\nüí° No para todos, muy restrictivo\n\n**Beneficios:**\n‚úÖ Autofagia (limpieza celular)\n‚úÖ Mayor quema de grasa\n‚úÖ Claridad mental\n‚úÖ Ahorro de tiempo\n‚úÖ Menos inflamaci√≥n\n\n**IMPORTANTE:**\n‚ö†Ô∏è Empieza gradual (12:12 ‚Üí 14:10 ‚Üí 16:8)\n‚ö†Ô∏è Escucha a tu cuerpo\n‚ö†Ô∏è Mant√©n electrolitos\n‚ö†Ô∏è Si sientes mal, come\n\nüí° **En ayuno puedes tomar:**\n‚Ä¢ Agua\n‚Ä¢ Caf√© negro\n‚Ä¢ T√© sin az√∫car\n‚Ä¢ Electrolitos\n\n¬øQuieres un plan para empezar con ayuno intermitente? ‚è∞',
      
      'üí° **Lectura de Etiquetas Nutricionales**\n\n¬°Ser un detective de etiquetas es clave en keto! üîç\n\n**LO QUE IMPORTA:**\n\n1Ô∏è‚É£ **CARBOHIDRATOS NETOS**\n   F√≥rmula: Carbos Totales - Fibra - Eritritol = Netos\n   \n   Ejemplo:\n   Carbos totales: 12g\n   Fibra: 8g\n   Eritritol: 2g\n   = 2g NETOS ‚úÖ\n\n2Ô∏è‚É£ **INGREDIENTES (orden importa)**\n   ‚Ä¢ Primeros 3 = mayor√≠a del producto\n   ‚Ä¢ Evita: az√∫car, jarabe de ma√≠z, maltodextrina\n   ‚Ä¢ Busca: ingredientes que reconoces\n\n3Ô∏è‚É£ **TAMA√ëO DE PORCI√ìN**\n   ‚ö†Ô∏è Truco com√∫n: porciones rid√≠culamente peque√±as\n   "Solo 2g carbos" pero porci√≥n = 15g (1 cucharada)\n   Siempre multiplica por porciones reales\n\n**SE√ëALES DE ALERTA:**\n\nüö© "Sin az√∫car a√±adida" (puede tener az√∫car natural)\nüö© "Bajo en grasa" (probablemente alto en carbos)\nüö© "Natural" (no significa keto-friendly)\nüö© "Keto" en el empaque (verifica n√∫meros)\n\n**AZ√öCARES OCULTOS:**\n\n‚ùå Maltodextrina\n‚ùå Dextrina\n‚ùå Jarabe de ma√≠z\n‚ùå Glucosa\n‚ùå Fructosa\n‚ùå Miel, agave, maple\n‚ùå Concentrado de frutas\n\n‚úÖ **Edulcorantes OK:**\n‚Ä¢ Eritritol\n‚Ä¢ Stevia\n‚Ä¢ Monk fruit\n‚Ä¢ Alulosa\n\n**REGLA DE ORO:**\nSi no entiendes un ingrediente ‚Üí Google antes de comprar\n\n¬øNecesitas ayuda revisando alg√∫n producto espec√≠fico? üì±',
    ];
    
    return {
      text: generalTips[Math.floor(Math.random() * generalTips.length)],
    };
  }

  // Default response - More personalized and conversational
  const defaultResponses = [
    'Interesante pregunta. ü§î Para darte la mejor respuesta posible, cu√©ntame un poco m√°s.\n\nEstoy especializado en:\n\nüçΩÔ∏è **Nutrici√≥n Keto**\n‚Ä¢ Recetas y planes de comidas\n‚Ä¢ C√°lculo de macros\n‚Ä¢ Tips para diferentes objetivos\n\nüõí **Productos**\n‚Ä¢ Recomendaciones personalizadas\n‚Ä¢ Kit de inicio para principiantes\n‚Ä¢ Opciones econ√≥micas\n\nüë®‚Äç‚öïÔ∏è **Asesor√≠a Profesional**\n‚Ä¢ Conectarte con nutricionistas certificados\n‚Ä¢ Especialistas en diabetes, deporte, p√©rdida de peso\n‚Ä¢ Consultas personalizadas\n\nüí¨ **Comunidad**\n‚Ä¢ Ver qu√© dicen otros usuarios\n‚Ä¢ Compartir experiencias\n‚Ä¢ Motivaci√≥n y apoyo\n\n¬øCu√°l de estos temas te interesa m√°s? O si tienes otra pregunta espec√≠fica, adelante. ¬°Estoy aqu√≠ para ayudarte! üíö',
    
    'Entiendo. D√©jame ayudarte de la mejor manera. üòä\n\n**Soy tu amigo keto personal** y puedo asistirte con:\n\nüéØ **Si eres nuevo en keto:**\n‚Ä¢ Gu√≠a paso a paso para empezar\n‚Ä¢ Lista de compras b√°sica\n‚Ä¢ Qu√© esperar las primeras semanas\n\nüí™ **Si ya tienes experiencia:**\n‚Ä¢ Optimizar tus resultados\n‚Ä¢ Recetas m√°s variadas\n‚Ä¢ Combinar keto con ejercicio\n\nüõçÔ∏è **Si quieres comprar:**\n‚Ä¢ Productos recomendados\n‚Ä¢ Kit de inicio con descuento\n‚Ä¢ Snacks y opciones gourmet\n\nüë©‚Äç‚öïÔ∏è **Si necesitas ayuda profesional:**\n‚Ä¢ Nutricionistas especializados\n‚Ä¢ Planes personalizados\n‚Ä¢ Seguimiento continuo\n\n¬øPor d√≥nde te gustar√≠a que empecemos? ü•ë',
    
    'Hmm, quiero asegurarme de entender bien tu necesidad para darte la mejor ayuda. üéØ\n\n**Algunas cosas que puedo hacer por ti:**\n\nüìö **Educaci√≥n:**\n‚Ä¢ Explicar conceptos keto (cetosis, macros, etc.)\n‚Ä¢ Resolver dudas sobre s√≠ntomas o efectos\n‚Ä¢ Tips y trucos probados\n\nüç≥ **Pr√°ctica:**\n‚Ä¢ Recetas f√°ciles y deliciosas\n‚Ä¢ Planes de comidas semanales\n‚Ä¢ Meal prep para ahorrar tiempo\n\nüé™ **Social:**\n‚Ä¢ C√≥mo comer fuera en keto\n‚Ä¢ Manejar fiestas y reuniones\n‚Ä¢ Resistir tentaciones\n\nüè• **Salud:**\n‚Ä¢ Keto para condiciones espec√≠ficas\n‚Ä¢ Conectarte con especialistas\n‚Ä¢ Monitoreo y seguimiento\n\n¬øAlguno de estos temas resuena con lo que necesitas? O cu√©ntame con tus propias palabras qu√© te trae por aqu√≠ hoy. ü§ó',
  ];
  
  return {
    text: defaultResponses[Math.floor(Math.random() * defaultResponses.length)],
  };
}

/**
 * Streaming simulation with enhanced responses
 * @param userMessage - The user's message to process
 * @param conversationHistory - Array of previous messages for context
 * @param userLocation - Optional user location for location-based features
 * @param wordDelayMs - Delay in milliseconds between each word (default: 30ms)
 */
export async function* simulateEnhancedStreamingResponse(
  userMessage: string,
  conversationHistory: Array<{ role: string; content: string }> = [],
  userLocation?: { latitude: number; longitude: number },
  wordDelayMs: number = 30
): AsyncGenerator<{ text: string; trigger?: SimulationTrigger; shouldRequestLocation?: boolean }, void, unknown> {
  const response = categorizeWithTriggers(userMessage, conversationHistory, userLocation);
  const words = response.text.split(' ');
  
  // Initial delay before starting
  await new Promise((resolve) => setTimeout(resolve, 500));
  
  for (const word of words) {
    yield { text: word + ' ', trigger: undefined };
    await new Promise((resolve) => setTimeout(resolve, wordDelayMs));
  }
  
  // Send trigger data at the end if any
  if (response.trigger || response.shouldRequestLocation) {
    yield { 
      text: '', 
      trigger: response.trigger,
      shouldRequestLocation: response.shouldRequestLocation 
    };
  }
}
